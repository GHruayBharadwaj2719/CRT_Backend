package CRT.service;

import CRT.dto.LessonResponse;
import CRT.entity.*;
import CRT.repository.LessonRepository;
import CRT.repository.NoteRepository;
import CRT.repository.ProblemRepository;
import org.springframework.stereotype.Service;

import java.util.*;

@Service
public class LessonService {

    private final LessonRepository lessonRepo;
    private final NoteRepository noteRepo;
    private final ProblemRepository problemRepo;

    public LessonService(
            LessonRepository lessonRepo,
            NoteRepository noteRepo,
            ProblemRepository problemRepo
    ) {
        this.lessonRepo = lessonRepo;
        this.noteRepo = noteRepo;
        this.problemRepo = problemRepo;
    }

    public List<LessonResponse> getLessonsByCategory(String category) {

        List<Lesson> lessons = lessonRepo.findByCategory(category);
        List<LessonResponse> result = new ArrayList<>();

        for (Lesson lesson : lessons) {
            LessonResponse res = new LessonResponse();
            res.id = lesson.getId();
            res.title = lesson.getTitle();
            res.duration = lesson.getDuration();

            // NOTES
            List<Notes> notes = noteRepo.findByLessonId(lesson.getId());
            Map<String, List<LessonResponse.Link>> noteMap = new HashMap<>();

            for (Notes n : notes) {
                String lang = n.getLanguage() == null ? "common" : n.getLanguage();
                noteMap.putIfAbsent(lang, new ArrayList<>());
                noteMap.get(lang).add(
                        new LessonResponse.Link(n.getName(), n.getUrl())
                );
            }
            res.notes = noteMap.isEmpty() ? null : noteMap;

            // PROBLEMS
            List<Problems> problems = problemRepo.findByLessonId(lesson.getId());
            List<LessonResponse.Link> probList = new ArrayList<>();

            for (Problems p : problems) {
                probList.add(
                        new LessonResponse.Link(p.getName(), p.getUrl())
                );
            }
            res.problems = probList;

            result.add(res);
        }
        return result;
    }
}
